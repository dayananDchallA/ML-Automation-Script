#!/usr/bin/env python
# coding: utf-8

# In[1]:


import pandas as pd
from EDA.OutlierHandling import OutlierHandling
from EDA.Encoding import Encoding
from EDA.NullHandling import NullHandling
from EDA.ColumnTypeIdentification import ColumnTypeIdentification
from EDA.FeatureReduction import FeatureReduction
import warnings
warnings.filterwarnings("ignore")
import threading
from Modelling.Classification import Classification
from Modelling.Regression import Regression
from sklearn.metrics import accuracy_score,f1_score,mean_squared_error
from itertools import product
from pathlib import Path
import json 
import matplotlib.pyplot as plt
import seaborn as sn







# In[2]:


from MLAccelerator import MLAccelerator


# In[3]:


from flask import Flask, render_template, request, redirect, url_for
import pandas as pd
app = Flask(__name__)


# render webpage
@app.route('/')
def index():
    return render_template('index.html')


@app.route('/upload', methods=['POST', 'GET'])
def upload():
    if request.method == 'POST':
        df = pd.read_csv(request.files.get('file'),delimiter=',')
        df.to_csv('dataframe.csv',index= False)
        corrMatrix = df.corr()
        svm=sn.heatmap(corrMatrix, annot=True, cmap='coolwarm', linewidth=2)
        figure = svm.get_figure()    
        figure.savefig('C:\\Users\\SindhuKarnati\\Desktop\\MLAccelarator\\static\\corr_pic1.png', dpi=400,bbox_inches='tight')
        return render_template('corr_page.html')

@app.route('/coltypes',method=['POST','GET'])
def coltypes():
	if request.method == 'POST':
		y = request.form['target']
        df=pd.read_csv('dataframe.csv')
        ml=MLAccelerator(df,'',[],[])
        result=ml.colIdentification(self, df, '')
		types = [k for k in result.colTypes.keys() for v in result.colTypes[k]]
		coltypes = [v for k in result.colTypes.keys() for v in result.colTypes[k]]
		data = pd.DataFrame.from_dict({'types': types, 'coltypes': coltypes})
        return render_template('col_types.html',data = data)



@app.route('/upload1', methods=['POST', 'GET'])
def upload1():
    if request.method == 'POST':
        df=pd.read_csv('dataframe.csv')
        df.to_csv('dataframe.csv',index= False)
        cols= list(df)
        return render_template('Home.html',data = cols)


@app.route('/submit',methods=['POST', 'GET'])   
def submit():
    if request.method == 'POST':
        flag_list ={}
        final_list={}
        cols_list=[]
        metric_dict={'accuracy_score':accuracy_score,'f1_score':f1_score,'mean_squared_error':mean_squared_error}
        flag_list['outlier']=request.form.getlist('outlier')
        flag_list['nullhandle']=request.form.getlist('nullhandle')
        flag_list['feature']=request.form.getlist('feature')
        flag_list['encoding']=request.form.getlist('encoding')
        flag_list['metric']=request.form.getlist('metric')
        flag_list['model']=request.form.getlist('model')
        flag_list['vector']=request.form.getlist('vector')
        cols_list = request.form.getlist('columns')
        for key in flag_list:
            if not flag_list[key]:
                final_list[key] = [None]
            else:
                final_list[key] = flag_list[key]
        y = request.form['target']
        df=pd.read_csv('dataframe.csv')
        ml=MLAccelerator(df[cols_list],y,final_list,metric_dict)
        result=ml.execute()
        return render_template('Output.html',data = result)
        


# In[ ]:

app.run()




